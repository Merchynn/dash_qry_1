WITH TAB_TEA AS (
  SELECT
    s.COD_ANALITICO_BENEFICIARIO,
    date(s.DAT_INCLUSAO) data_inclusao,
    s.COD_PRESTADOR,
    s.NUM_STATUS,
    s.NUM_GUIA_PRESTADOR,
    s.NUM_SOLICITACAO_VPP_REF,
    s.COD_TIPO_CANAL,
    i.NUM_SOLIC_SP_SADT_ITEM,
    i.NUM_SOLICITACAO_VPP,
    i.QTD_SOLICITADA,
    i.QTD_AUTORIZADA,
    i.COD_SERVICO,
    i.NUM_TAB_MEDICA,
    i.IDC_STATUS_ITEM,
    i.NME_TRANSACAO_CDC,
    ROW_NUMBER() OVER (PARTITION BY s.COD_ANALITICO_BENEFICIARIO ORDER BY s.DAT_INCLUSAO DESC) as rn
  FROM
    `seu_projeto_dados.dataset_transacional.itens_solicitacao_servico` I -- Tabela censurada
  INNER JOIN (
    SELECT
      CONCAT(s.COD_PREF_EMPRESA, s.cod_empresa, s.COD_FAMILIAR_BENEF, s.COD_RDP) AS COD_ANALITICO_BENEFICIARIO,
      NUM_SOLICITACAO_VPP,
      s.DAT_INCLUSAO,
      s.COD_PRESTADOR,
      s.NUM_STATUS,
      s.NUM_GUIA_PRESTADOR,
      s.NUM_SOLICITACAO_VPP_REF,
      s.COD_TIPO_CANAL
    FROM
      `seu_projeto_dados.dataset_transacional.solicitacoes_servico` s -- Tabela censurada
  ) s ON I.NUM_SOLICITACAO_VPP = S.NUM_SOLICITACAO_VPP
  WHERE
    i.COD_SERVICO IN ('ID_SERVICO_TIPO_A', 'ID_SERVICO_TIPO_B', 'ID_SERVICO_TIPO_C', 'ID_SERVICO_TIPO_D') -- Valores de filtro censurados
)
-----------
, ultimo_atend_tea as (
  SELECT
    T.*,
    C.COD_CARTEIRINHA_BENEFICIARIO,
    C.NME_BENEFICIARIO,
    C.NUM_CPF,
    C.NUM_CPF_TITULAR,
    C.DSC_EMAIL,
    C.DSC_EMAIL_TITULAR,
    C.NUM_TELEFONE,
    C.NUM_TELEFONE_TITULAR,
    C.COD_PLANO,
    C.COD_SUBPADRAO_PLANO,
    C.DSC_SUBPADRAO_PLANO,
    C.status_beneficiario,
    CASE
      WHEN T.rn = 1 THEN 'S'
      ELSE 'N'
    END AS flag_ultimo_atendendimento
  FROM
    TAB_TEA T
  INNER JOIN (
    SELECT
      COD_CARTEIRINHA_BENEFICIARIO,
      NME_BENEFICIARIO,
      NUM_CPF,
      NUM_CPF_TITULAR,
      DSC_EMAIL,
      DSC_EMAIL_TITULAR,
      NUM_TELEFONE,
      NUM_TELEFONE_TITULAR,
      COD_PLANO,
      COD_SUBPADRAO_PLANO,
      DSC_SUBPADRAO_PLANO,
      COD_ANALITICO_BENEFICIARIO,
      CASE
        WHEN DAT_FIM_VIGENCIA_PLANO = '9999-12-31' THEN 'ATIVO'
        ELSE 'INATIVO'
      END AS status_beneficiario
    FROM `seu_projeto_dados.dataset_referencia.cadastro_beneficiarios` -- Tabela censurada
  ) C ON T.COD_ANALITICO_BENEFICIARIO = C.COD_ANALITICO_BENEFICIARIO
)
--------------
, adicional_tea as (
  SELECT
    u.*,
    A.COD_VII,
    A.DSC_CARTEIRA_EMPRESA,
    A.COD_SERVICO AS COD_SERVICO_DASH,
    A.NME_PLANO AS NME_PLANO_DASH,
    A.NME_PLANO_AJUSTADO,
    A.COD_PRESTADOR AS COD_PRESTADOR_DASH,
    A.NME_FANTASIA_PRESTADOR,
    A.MUNICIPIO_PRESTADOR,
    A.UF_PRESTADOR,
    A.COD_GRUPO_ECONOMICO_EMPRESA,
    A.NME_GRUPO_ECONOMICO_EMPRESA,
    A.COD_EMPRESA_PAGAMENTO_SEGURO,
    A.NME_FANTASIA_EMPRESA,
    A.VALOR_PAGO,
    A.DAT_EXECUCAO_SINISTRO,
    A.DSC_TIPO_SINISTRO,
    A.FLG_LIMINAR
  FROM
    ultimo_atend_tea u
  INNER JOIN (
    SELECT
      COD_VII, COD_CARTEIRINHA_BENEFICIARIO, DSC_CARTEIRA_EMPRESA, COD_SERVICO,
      NME_PLANO, NME_PLANO_AJUSTADO, COD_PRESTADOR, NME_FANTASIA_PRESTADOR,
      MUNICIPIO_PRESTADOR, UF_PRESTADOR, COD_GRUPO_ECONOMICO_EMPRESA,
      NME_GRUPO_ECONOMICO_EMPRESA, COD_EMPRESA_PAGAMENTO_SEGURO,
      NME_FANTASIA_EMPRESA, VALOR_PAGO, DAT_EXECUCAO_SINISTRO,
      DSC_TIPO_SINISTRO, FLG_LIMINAR
    FROM
      `seu_projeto_analytics.dataset_comando.dados_dashboard_especifico` A -- Tabela censurada
  ) A ON u.COD_CARTEIRINHA_BENEFICIARIO = A.COD_CARTEIRINHA_BENEFICIARIO
)
--------- SELECT FINAL
SELECT
  COD_ANALITICO_BENEFICIARIO,
  data_inclusao,
  COD_PRESTADOR,
  NUM_STATUS,
  NUM_GUIA_PRESTADOR,
  NUM_SOLICITACAO_VPP_REF,
  COD_TIPO_CANAL,
  NUM_SOLIC_SP_SADT_ITEM,
  NUM_SOLICITACAO_VPP,
  QTD_SOLICITADA,
  QTD_AUTORIZADA,
  COD_SERVICO,
  NUM_TAB_MEDICA,
  IDC_STATUS_ITEM,
  NME_TRANSACAO_CDC,
  rn,
  COD_CARTEIRINHA_BENEFICIARIO,
  NME_BENEFICIARIO,
  NUM_CPF,
  NUM_CPF_TITULAR,
  DSC_EMAIL,
  DSC_EMAIL_TITULAR,
  NUM_TELEFONE,
  NUM_TELEFONE_TITULAR,
  COD_PLANO,
  COD_SUBPADRAO_PLANO,
  DSC_SUBPADRAO_PLANO,
  status_beneficiario,
  flag_ultimo_atendendimento,
  COD_VII,
  DSC_CARTEIRA_EMPRESA,
  COD_SERVICO_DASH,
  NME_PLANO_DASH,
  NME_PLANO_AJUSTADO,
  COD_PRESTADOR_DASH,
  NME_FANTASIA_PRESTADOR,
  MUNICIPIO_PRESTADOR,
  UF_PRESTADOR,
  COD_GRUPO_ECONOMICO_EMPRESA,
  NME_GRUPO_ECONOMICO_EMPRESA,
  COD_EMPRESA_PAGAMENTO_SEGURO,
  NME_FANTASIA_EMPRESA,
  VALOR_PAGO,
  DAT_EXECUCAO_SINISTRO,
  DSC_TIPO_SINISTRO,
  FLG_LIMINAR
  --SUM(VALOR_PAGO) OVER () AS VALOR_PAGO_TOTAL,
  --COUNT(DISTINCT CONCAT(COD_CARTEIRINHA_BENEFICIARIO, '-', FORMAT_DATE('%Y%m%d', DAT_EXECUCAO_SINISTRO))) OVER () AS qnt_atend,
  --SAFE_DIVIDE(
  --  SUM(VALOR_PAGO) OVER (),
  --  COUNT(DISTINCT CONCAT(COD_CARTEIRINHA_BENEFICIARIO, '-', FORMAT_DATE('%Y%m%d', DAT_EXECUCAO_SINISTRO))) OVER ()
  --) AS custo_medio
FROM
  adicional_tea;
